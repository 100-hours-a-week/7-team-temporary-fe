name: BigBang-FE-CD

on:
  push:
    branches:
      - main
      - "release/**"
permissions:
  contents: read
  id-token: write

concurrency:
  group: fe-cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build Artifact
    runs-on: ubuntu-latest

    steps:
      #체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      #Node.js 설치 (LTS 권장)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      #Corepack 활성화 / pnpm 설치
      - name: Enable Corepack (pnpm)
        run: |
          corepack enable
          corepack prepare pnpm@9.15.1 --activate
          
      #의존성 설치
      - name: Install dependencies
        run: |
          set -euo pipefail
          pnpm install --frozen-lockfile

      - name: Build (Next.js)
        run: pnpm run build

      - name: Package artifact
        run: |
          set -euo pipefail
          if [ ! -d ".next" ]; then
            echo "Build output (.next) not found"; exit 1;
          fi
          mkdir -p release_bundle
          cp -r .next release_bundle/
          for path in public package.json pnpm-lock.yaml next.config.ts; do
            if [ -e "$path" ]; then
              cp -r "$path" release_bundle/
            fi
          done
          tar -czf app.tar.gz -C release_bundle .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: app.tar.gz
          retention-days: 3

  deploy_aws:
    name: Deploy to AWS (release)
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/release/')
    env:
      AWS_HOST: ${{ secrets.HOST_STAGING }}
      AWS_USER: ${{ secrets.USER_STAGING }}
      AWS_TARGET_DIR: ${{ secrets.APP_DIR_AWS }}
      AWS_SERVICE: ${{ secrets.PM2_NAME }}

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build
          path: .

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY_STAGING }}

      - name: Add host key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -H "$AWS_HOST" >> ~/.ssh/known_hosts

      - name: Deploy (pm2)
        run: |
            set -euo pipefail
            if [ -z "$AWS_HOST" ] || [ -z "$AWS_USER" ] || [ -z "$AWS_TARGET_DIR" ]; then
              echo "Missing AWS_HOST/AWS_USER/AWS_TARGET_DIR secrets"; exit 1;
            fi
            scp app.tar.gz ${AWS_USER}@${AWS_HOST}:/tmp/app.tar.gz
            ssh ${AWS_USER}@${AWS_HOST} "AWS_TARGET_DIR='${AWS_TARGET_DIR}' AWS_SERVICE='${AWS_SERVICE:-app}' bash -se" <<'EOSSH'
              set -euo pipefail
              TARGET_DIR="${AWS_TARGET_DIR:-}"
              if [ -z "${TARGET_DIR}" ]; then
                echo "AWS_TARGET_DIR is empty"; exit 1;
              fi
              case "$TARGET_DIR" in
                "~"|"~/"*) TARGET_DIR="${HOME}${TARGET_DIR#\~}";;
              esac
              if ! command -v node >/dev/null 2>&1; then
                echo "Node.js is required on target host"; exit 1;
              fi
              if command -v corepack >/dev/null 2>&1; then
                corepack enable
                corepack prepare pnpm@9.15.1 --activate
              fi
              if ! command -v pm2 >/dev/null 2>&1; then
                echo "pm2 is required on target host"; exit 1;
              fi
              RELEASE_DIR="${TARGET_DIR}/releases/$(date +%Y%m%d_%H%M%S)"
              CURRENT_LINK="${TARGET_DIR}/current"
              
              mkdir -p "${RELEASE_DIR}"
              tar -xzf /tmp/app.tar.gz -C "${RELEASE_DIR}"
              cd "${RELEASE_DIR}"
              pnpm install --prod --frozen-lockfile
              ln -sfn "${RELEASE_DIR}" "${CURRENT_LINK}"
              
              cd "${TARGET_DIR}"
              pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js
              
              ls -dt ${TARGET_DIR}/releases/* 2>/dev/null | tail -n +4 | xargs -r rm -rf || true
            EOSSH


  deploy_gcp:
    name: Deploy to GCP (main)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      GCP_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
      GCP_ZONE: ${{ secrets.GCP_ZONE }}
      GCP_INSTANCE: ${{ secrets.GCE_INSTANCE_NAME }}
      GCP_USER: ${{ secrets.GCE_USER }}
      GCP_TARGET_DIR: ${{ secrets.APP_DIR_GCP }}
      GCP_SERVICE: ${{ secrets.PM2_NAME }}
    steps:

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build
          path: .

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}


      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Force set active project (critical)
        shell: bash
        run: |
          set -euo pipefail
          gcloud config set project "${GCP_PROJECT}"
          echo "ACTIVE_PROJECT=$(gcloud config get-value project)"
          gcloud config list
          
      - name: SSH into VM (public IP) and run simple commands
        shell: bash
        run: |
          set -euo pipefail
          echo "Using project=${GCP_PROJECT}, zone=${GCP_ZONE}, instance=${GCP_INSTANCE}, user=${GCP_USER}"
          gcloud compute ssh "${GCP_INSTANCE}" \
            --project "${GCP_PROJECT}" \
            --zone "${GCP_ZONE}" \
            --quiet \
            --command "echo 'SSH_OK'; whoami; hostname; uname -a"

      - name: Deploy (pm2)
        run: |
          set -euo pipefail
          gcloud compute scp app.tar.gz \
            ${GCP_USER}@${GCP_INSTANCE}:/tmp/app.tar.gz \
            --zone="${GCP_ZONE}" \
            --project="${GCP_PROJECT}" \
            --quiet
          
          gcloud compute ssh ${GCP_USER}@${GCP_INSTANCE} \
            --zone "${GCP_ZONE}" \
            --project "${GCP_PROJECT}" \
            --quiet \
            --command "GCP_TARGET_DIR='${GCP_TARGET_DIR}' GCP_SERVICE='${GCP_SERVICE:-app}' bash -se" <<'EOSSH'
            set -euo pipefail
            TARGET_DIR="${GCP_TARGET_DIR:-}"
            if [ -z "${TARGET_DIR}" ]; then
              echo "GCP_TARGET_DIR is empty"; exit 1;
            fi
            case "$TARGET_DIR" in
              "~"|"~/"*) TARGET_DIR="${HOME}${TARGET_DIR#\~}";;
            esac
            if ! command -v node >/dev/null 2>&1; then
              echo "Node.js is required on target host"; exit 1;
            fi
            if command -v corepack >/dev/null 2>&1; then
              corepack enable
              corepack prepare pnpm@9.15.1 --activate
            fi
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "pm2 is required on target host"; exit 1;
            fi
            RELEASE_DIR="${TARGET_DIR}/releases/$(date +%Y%m%d_%H%M%S)"
            CURRENT_LINK="${TARGET_DIR}/current"
            mkdir -p "${RELEASE_DIR}"
            tar -xzf /tmp/app.tar.gz -C "${RELEASE_DIR}"
            cd "${RELEASE_DIR}"
            pnpm install --prod --frozen-lockfile
            ln -sfn "${RELEASE_DIR}" "${CURRENT_LINK}"
            cd "${TARGET_DIR}"
            pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js
            ls -dt ${TARGET_DIR}/releases/* 2>/dev/null | tail -n +4 | xargs -r rm -rf || true
          EOSSH
