## 13. Polyfill 전략

### 13.1 기본 원칙

- 필요한 경우에만 selective polyfill 적용
- core-js 전체 polyfill 사용 지양

### 13.2 적용 기준

- 브라우저 분포와 사용자 영향도를 기준으로 도입 여부를 결정한다.

### 13.4 Next.js(App Router) 기준 Polyfill 적용 위치

#### 13.4.1 기본 원칙

- Polyfill은 클라이언트 런타임에서만 필요한 경우에 한해 적용한다.
- 서버(Node.js) 실행 환경에서는 최신 런타임(Node 22.x)을 전제로 하므로 Polyfill을 적용하지 않는다.
- App Router 환경에서는 전역 주입을 최소화하고, 필요 범위에 한정한다.

#### 13.4.2 적용 위치별 기준

##### (1) 전역 적용이 필요한 경우

- 다수의 페이지/컴포넌트에서 공통적으로 사용하는 API
- 앱 초기화 이전에 반드시 존재해야 하는 API

적용 위치

```ts
// app/polyfills.ts
```

```ts
// app/layout.tsx
import "./polyfills";
```

예시 대상

- `fetch` (특정 환경)
- `URLSearchParams`
- `Promise` (구형 환경 대응 시)

> App Router에서는 `_app.tsx`가 없으므로
> `root layout.tsx`가 전역 주입 지점이다.

##### (2) 특정 기능/페이지 한정 Polyfill

- 특정 API를 사용하는 기능이 명확한 경우
- 전체 앱에 전역 영향이 불필요한 경우

적용 방식

- 해당 feature/widget 내부에서 조건부 import
- 또는 동적 import로 런타임 로딩

```ts
if (!("IntersectionObserver" in window)) {
  await import("intersection-observer");
}
```

권장

- feature 단위에서 책임을 명확히 유지한다.
- 전역 오염을 방지한다.

#### 13.4.3 적용하지 않는 위치

- `shared/lib`, `entities/model` 등 도메인 로직 계층
- 서버 컴포넌트(`.tsx` without `"use client"`)

Polyfill은 환경 보완 코드이지, 도메인 로직의 일부가 아니다.

### 13.5 PWA 환경에서 Polyfill 판단 기준

#### 13.5.1 PWA 특성 고려 사항

PWA는 다음 환경을 포함한다.

- 모바일 Safari (iOS)
- Android WebView
- Standalone 모드(Home Screen 실행)
- 네트워크 불안정/오프라인 상태

데스크톱 브라우저 기준 판단은 충분하지 않다.

#### 13.5.2 Polyfill 도입 판단 기준

Polyfill 적용 여부는 아래 기준을 순서대로 판단한다.

1. PWA 핵심 기능에 영향이 있는가
   - 로그인
   - 플래너 작성/조회
   - 오프라인 캐시
2. 미지원 시 대체 UX가 가능한가
   - 단순 애니메이션은 미적용
   - 스크롤 관측 기반 로딩은 대체 가능 여부 판단
3. iOS Safari/WebView 지원 여부
   - `IntersectionObserver`, `ResizeObserver`, `Clipboard API`
4. Service Worker와 충돌 가능성
   - 전역 객체 오염 여부
   - 캐시 전략 간섭 여부

#### 13.5.3 PWA 환경에서 권장 전략

- Polyfill은 기능 단위로 국소 적용한다.
- 앱 초기 로딩에 영향을 주는 Polyfill은 최대한 배제한다.
- 오프라인/캐시 전략과 무관한 API만 Polyfill 대상으로 고려한다.
- Web API 미지원 시 Graceful Degradation을 우선 적용한다.

#### 13.5.4 적용 예시 (문서용)

```md
- PWA 환경에서는 iOS Safari 및 Android WebView의 API 지원 범위를 고려하여
  Polyfill 적용 여부를 판단한다.
- 핵심 기능 동작에 영향을 미치는 경우에 한해 제한적으로 Polyfill을 적용하며,
  초기 로딩 성능에 영향을 주는 전역 Polyfill은 지양한다.
```

정리 요약

- Next.js(App Router): `app/layout.tsx`가 전역 Polyfill 진입점이다.
- PWA 환경: 데스크톱 기준이 아닌 모바일 Safari/WebView 기준으로 판단한다.
- Polyfill은 기술적 편의가 아니라 지원 환경 전략의 결과물이다.

---
